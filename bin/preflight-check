#!/bin/bash
# Preflight Environment Checker for VPS Provisioning Project
# Verifies development environment meets minimum requirements
#
# Usage: ./bin/preflight-check [--fix]

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

FIX_MODE=false
if [[ "${1:-}" == "--fix" ]]; then
  FIX_MODE=true
fi

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  Preflight Environment Check${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

CHECKS_PASSED=0
CHECKS_FAILED=0

print_result() {
  local status="$1"
  local message="$2"
  
  case "$status" in
    "pass") echo -e "  ${GREEN}✓${NC} $message"; ((CHECKS_PASSED++)) ;;
    "fail") echo -e "  ${RED}✗${NC} $message"; ((CHECKS_FAILED++)) ;;
    "info") echo -e "  ${BLUE}ℹ${NC} $message" ;;
  esac
}

# CHECK 1: Required dependencies
echo -e "${YELLOW}[1/4]${NC} Checking required dependencies..."

DEPS=("git" "bash" "python3" "make")

for dep in "${DEPS[@]}"; do
  if command -v "${dep}" &>/dev/null; then
    version=$("${dep}" --version 2>&1 | head -1 || echo "unknown")
    print_result "pass" "${dep} installed (${version})"
  else
    print_result "fail" "${dep} not installed"
    if [[ "$FIX_MODE" == "true" ]]; then
      echo -e "       ${BLUE}Attempting to install ${dep}...${NC}"
      sudo apt-get install -y "${dep}" || echo -e "       ${RED}Failed to install ${dep}${NC}"
    fi
  fi
done

# Check optional but recommended
OPTIONAL_DEPS=("bats" "shellcheck" "jq")

for dep in "${OPTIONAL_DEPS[@]}"; do
  if command -v "${dep}" &>/dev/null; then
    version=$("${dep}" --version 2>&1 | head -1 || echo "unknown")
    print_result "pass" "${dep} installed (optional)"
  else
    print_result "info" "${dep} not installed (optional, install: sudo apt-get install ${dep})"
  fi
done

echo ""

# CHECK 2: Git configuration
echo -e "${YELLOW}[2/4]${NC} Checking Git configuration..."

if git config user.name &>/dev/null && [[ -n "$(git config user.name)" ]]; then
  print_result "pass" "Git user.name configured: $(git config user.name)"
else
  print_result "fail" "Git user.name not configured"
  if [[ "$FIX_MODE" == "true" ]]; then
    read -rp "Enter your Git username: " git_name
    git config --global user.name "$git_name"
    print_result "info" "Git user.name configured"
  fi
fi

if git config user.email &>/dev/null && [[ -n "$(git config user.email)" ]]; then
  print_result "pass" "Git user.email configured: $(git config user.email)"
else
  print_result "fail" "Git user.email not configured"
  if [[ "$FIX_MODE" == "true" ]]; then
    read -rp "Enter your Git email: " git_email
    git config --global user.email "$git_email"
    print_result "info" "Git user.email configured"
  fi
fi

echo ""

# CHECK 3: Development environment
echo -e "${YELLOW}[3/4]${NC} Validating development environment..."

# Check minimum disk space (1GB)
AVAILABLE_SPACE=$(df -BG . | tail -1 | awk '{print $4}' | sed 's/G//')
if [[ "$AVAILABLE_SPACE" -gt 1 ]]; then
  print_result "pass" "Sufficient disk space: ${AVAILABLE_SPACE}GB available"
else
  print_result "fail" "Insufficient disk space: ${AVAILABLE_SPACE}GB (minimum: 1GB)"
fi

# Check if in git repository
if git rev-parse --git-dir &>/dev/null; then
  print_result "pass" "Inside Git repository"
else
  print_result "fail" "Not inside Git repository"
fi

# Check project structure
REQUIRED_DIRS=("lib" "bin" "tests" "config")
for dir in "${REQUIRED_DIRS[@]}"; do
  if [[ -d "$dir" ]]; then
    print_result "pass" "Directory exists: $dir/"
  else
    print_result "fail" "Missing directory: $dir/"
  fi
done

echo ""

# CHECK 4: Git hooks setup
echo -e "${YELLOW}[4/4]${NC} Checking Git hooks..."

HOOKS=("pre-commit" "pre-push")
for hook in "${HOOKS[@]}"; do
  if [[ -x ".git/hooks/$hook" ]]; then
    print_result "pass" "Git hook installed and executable: $hook"
  elif [[ -f ".git/hooks/$hook" ]]; then
    print_result "fail" "Git hook not executable: $hook (run: chmod +x .git/hooks/$hook)"
  else
    print_result "info" "Git hook not installed: $hook"
  fi
done

echo ""

# Summary
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
if [[ $CHECKS_FAILED -eq 0 ]]; then
  echo -e "${GREEN}✓ Preflight check passed!${NC}"
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "  Checks passed: ${GREEN}${CHECKS_PASSED}${NC}"
  echo -e "  Checks failed: ${RED}${CHECKS_FAILED}${NC}"
  echo ""
  echo -e "${GREEN}Environment is ready for development.${NC}"
  exit 0
else
  echo -e "${RED}✗ Preflight check failed!${NC}"
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "  Checks passed: ${GREEN}${CHECKS_PASSED}${NC}"
  echo -e "  Checks failed: ${RED}${CHECKS_FAILED}${NC}"
  echo ""
  if [[ "$FIX_MODE" == "false" ]]; then
    echo -e "${YELLOW}Run './bin/preflight-check --fix' to automatically fix some issues.${NC}"
  fi
  exit 1
fi
